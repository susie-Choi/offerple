<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROTA - Vulnerability Knowledge Graph</title>
    <script src="https://unpkg.com/neovis.js@2.1.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
        }

        .header {
            background: #2d2d2d;
            padding: 20px;
            border-bottom: 2px solid #4a9eff;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header p {
            color: #aaa;
            margin-top: 5px;
        }

        .controls {
            background: #2d2d2d;
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .controls input {
            padding: 8px 12px;
            border: 1px solid #555;
            background: #1a1a1a;
            color: #fff;
            border-radius: 4px;
            font-size: 14px;
            flex: 1;
            max-width: 300px;
        }

        .controls button {
            padding: 8px 20px;
            background: #4a9eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .controls button:hover {
            background: #3a8eef;
        }

        .controls select {
            padding: 8px 12px;
            border: 1px solid #555;
            background: #1a1a1a;
            color: #fff;
            border-radius: 4px;
            font-size: 14px;
        }

        #viz {
            width: 100%;
            height: calc(100vh - 140px);
            background: #1a1a1a;
        }

        .info-panel {
            position: absolute;
            top: 140px;
            right: 20px;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            max-width: 300px;
            border: 1px solid #444;
            display: none;
        }

        .info-panel h3 {
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .info-panel p {
            margin: 5px 0;
            font-size: 14px;
            color: #ccc;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #4a9eff;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ”’ ROTA - Vulnerability Knowledge Graph</h1>
        <p>Interactive visualization of CVEs, Exploits, and Security Advisories</p>
    </div>

    <div class="controls">
        <select id="queryType">
            <option value="overview">Overview (100 nodes)</option>
            <option value="cve">Search CVE</option>
            <option value="highRisk">High Risk CVEs (EPSS > 0.5)</option>
            <option value="withExploits">CVEs with Exploits</option>
            <option value="recentCVEs">Recent CVEs (2024)</option>
        </select>
        <input type="text" id="searchInput" placeholder="Enter CVE ID (e.g., CVE-2021-44228)" style="display:none;">
        <button onclick="loadGraph()">Load Graph</button>
        <button onclick="resetView()">Reset View</button>
    </div>

    <div id="viz"></div>

    <div class="legend">
        <h4>Node Types</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff6b6b;"></div>
            <span>CVE</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4ecdc4;"></div>
            <span>Exploit</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #95e1d3;"></div>
            <span>Advisory</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f38181;"></div>
            <span>Package</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #aa96da;"></div>
            <span>Commit</span>
        </div>
    </div>

    <script>
        let viz;
        
        // Show/hide search input based on query type
        document.getElementById('queryType').addEventListener('change', function() {
            const searchInput = document.getElementById('searchInput');
            searchInput.style.display = this.value === 'cve' ? 'block' : 'none';
        });

        function getQuery() {
            const queryType = document.getElementById('queryType').value;
            const searchValue = document.getElementById('searchInput').value;

            const queries = {
                overview: `
                    MATCH (n)
                    WITH n LIMIT 100
                    OPTIONAL MATCH (n)-[r]->(m)
                    RETURN n, r, m
                `,
                cve: `
                    MATCH (c:CVE {id: '${searchValue}'})
                    OPTIONAL MATCH (c)-[r1:HAS_EXPLOIT]->(e:Exploit)
                    OPTIONAL MATCH (c)-[r2:HAS_ADVISORY]->(a:Advisory)
                    OPTIONAL MATCH (c)-[r3:FIXED_BY]->(commit:Commit)
                    OPTIONAL MATCH (c)-[r4:AFFECTS]->(p:Package)
                    RETURN c, r1, e, r2, a, r3, commit, r4, p
                `,
                highRisk: `
                    MATCH (c:CVE)
                    WHERE c.epss_score > 0.5
                    WITH c LIMIT 50
                    OPTIONAL MATCH (c)-[r]->(n)
                    RETURN c, r, n
                `,
                withExploits: `
                    MATCH (c:CVE)-[r:HAS_EXPLOIT]->(e:Exploit)
                    WITH c, r, e LIMIT 50
                    RETURN c, r, e
                `,
                recentCVEs: `
                    MATCH (c:CVE)
                    WHERE c.published STARTS WITH '2024'
                    WITH c LIMIT 50
                    OPTIONAL MATCH (c)-[r]->(n)
                    RETURN c, r, n
                `
            };

            return queries[queryType] || queries.overview;
        }

        function loadGraph() {
            const config = {
                containerId: "viz",
                neo4j: {
                    serverUrl: "neo4j+s://26e236b3.databases.neo4j.io",
                    serverUser: "neo4j",
                    serverPassword: "yc-TW0XnNO3rV9u0mSR59BVHxlyeJjTC8ngO3QhbkVw"
                },
                visConfig: {
                    nodes: {
                        shape: 'dot',
                        font: {
                            size: 14,
                            color: '#ffffff'
                        }
                    },
                    edges: {
                        arrows: {
                            to: { enabled: true, scaleFactor: 0.5 }
                        },
                        color: { color: '#666666' },
                        font: {
                            size: 12,
                            color: '#ffffff',
                            strokeWidth: 0
                        }
                    },
                    physics: {
                        enabled: true,
                        stabilization: {
                            iterations: 200
                        },
                        barnesHut: {
                            gravitationalConstant: -8000,
                            springConstant: 0.04,
                            springLength: 95
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 200
                    }
                },
                labels: {
                    CVE: {
                        label: "id",
                        value: "cvssScore",
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            function: {
                                title: (node) => {
                                    return `CVE: ${node.id}\nCVSS: ${node.cvssScore || 'N/A'}\nEPSS: ${node.epss_score || 'N/A'}`;
                                }
                            },
                            static: {
                                color: "#ff6b6b",
                                size: 25
                            }
                        }
                    },
                    Exploit: {
                        label: "edb_id",
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            static: {
                                color: "#4ecdc4",
                                size: 20
                            }
                        }
                    },
                    Advisory: {
                        label: "ghsa_id",
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            static: {
                                color: "#95e1d3",
                                size: 20
                            }
                        }
                    },
                    Package: {
                        label: "name",
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            static: {
                                color: "#f38181",
                                size: 20
                            }
                        }
                    },
                    Commit: {
                        label: "sha",
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            function: {
                                title: (node) => {
                                    return `Commit: ${node.sha?.substring(0, 7)}\n${node.message || ''}`;
                                }
                            },
                            static: {
                                color: "#aa96da",
                                size: 15
                            }
                        }
                    }
                },
                relationships: {
                    HAS_EXPLOIT: {
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            static: {
                                label: "HAS_EXPLOIT",
                                color: "#ff6b6b"
                            }
                        }
                    },
                    HAS_ADVISORY: {
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            static: {
                                label: "HAS_ADVISORY",
                                color: "#4ecdc4"
                            }
                        }
                    },
                    FIXED_BY: {
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            static: {
                                label: "FIXED_BY",
                                color: "#95e1d3"
                            }
                        }
                    },
                    AFFECTS: {
                        [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                            static: {
                                label: "AFFECTS",
                                color: "#f38181"
                            }
                        }
                    }
                },
                initialCypher: getQuery()
            };

            viz = new NeoVis(config);
            viz.render();
        }

        function resetView() {
            if (viz) {
                viz.stabilize();
            }
        }

        // Load graph on page load
        window.onload = function() {
            loadGraph();
        };
    </script>
</body>
</html>
